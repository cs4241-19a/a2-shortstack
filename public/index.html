<!doctype html>
<html lang="en">
  <head>
    <title>CS4241 Assignment 2</title>
    <meta charset="utf-8">
    <link href="./css/style.css" rel="stylesheet">
  </head>

  <body>
    <h1><font size="+3">Enter Information Of Your Car To Estimate Its Value</font></h1>

    <div class="split left">
      <form action="">
        <br><br><br>
        <select id='model'>
          <option value="Nissan">Nissan</option>
          <option value="Toyota">Toyota</option>
          <option value="Honda">Honda</option>
          <option value="Mercedes">Mercedes</option>
          <option value="Audi">Audi</option>
          <option value="Subaru">Subaru</option>
          <option value="Lamborghini">Lamborghini</option>
        </select>
        <input type='text' id='id' placeholder="ID"><br><br><br>
        <input type='text' id='year' placeholder="Year"><br><br><br>
        <input type='text' id='mpg' placeholder="MPG"><br><br><br><br>
        <button id='add'>Add</button>
        <button id='del'>Delete</button>
        <button id='mod'>Update</button>
      </form>
    </div>
    <div class="split right">
      <h2>Vehicle Database</h2>
      <table id="database" width="100%" border=1>
          <tr>
            <td>&nbsp;</td>
          </tr>
        </table>
  </body>

  <script>
let ID = 3;

//let table = document.getElementById('database').getElementsByTagName('tr');
//console.log(element);

// GET
const createHeader = function() {
  database.innerHTML = ""
  const headerList = ["ID", "Model", "Year", "MPG", "Value($)", "Icon"]
  var tr = document.createElement('tr');
  tr.style.width = '100%';
  tr.setAttribute('border', '1');
  for(let i = 0; i < headerList.length; i++) {
    let header = headerList[i];
    let th = document.createElement('th');
    th.innerHTML = header;
    tr.appendChild(th);
  }
  database.appendChild(tr);
}

const getCar = function () {
  fetch('/get', {
        method: 'GET'
    }).then(function (response) {
        return response.json();
    }).then(function (data) {
      console.log(data)
      createHeader()
      data.map(function (entry) {
        const headerList = [
          entry.id, entry.model, entry.year, 
          entry.mpg, entry.value
        ]
        let tr = document.createElement('tr');
        for(let i = 0; i < headerList.length; i++) {
          let key = headerList[i];
          let td = document.createElement('th');
          td.innerHTML = key;
          tr.appendChild(td);
        }
        database.appendChild(tr);
      })
    })
}

// POST 
function postRequest(req) {
    // prevent default form action from being carried out
    const model = document.querySelector( '#model' ),
          year = document.querySelector( '#year' ),
          mpg = document.querySelector( '#mpg' ),
          idInput = document.querySelector( '#id' ).value,
          id = function() {
            if (req === "add"){
              return ID++;
            }
            else {
              if(idInput !== ""){
                return parseInt(idInput);
              }else{
                return ID++;
              }
            }
          }
          //id = (req !== "add" && idInput !== "") ? parseInt(idInput) : ID++,
          json = {
            id: id(),
            model: model.value,
            year: parseInt(year.value),
            mpg: parseInt(mpg.value),
            value: 0
          },
          body = JSON.stringify( json )

    fetch( `/${req}`, {
      method:'POST',
      body 
    })
    .then( function( response ) {
      console.log( "Add to server: " + response )
      getCar() //get
    })
  }

// POST - ADD
const addCar = function( e ) {
  e.preventDefault()
  postRequest("add")
  return false
}

// POST - DELETE
const deleteCar = function( e ) {
  e.preventDefault()
  postRequest("delete")
  return false
}

// POST - MODIFY
const modifyCar = function( e ) {
  e.preventDefault()
  postRequest("modify")
  return false
}


const addButton = document.getElementById('add');
const deleteButton = document.getElementById('del');
const modifyButton = document.getElementById('mod');
addButton.onclick = addCar;
deleteButton.onclick = deleteCar;
modifyButton.onclick = modifyCar;

window.onload = function() {
  getCar()
}



  </script>

</html>
