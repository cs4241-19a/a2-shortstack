<!doctype html>
<html lang="en">
  <head>
    <title>CS4241 Assignment 2</title>
    <meta charset="utf-8">
  </head>
  <body>
    <label> Username: </label>
    <input id="username" type="text"/>  <br/>
    <label> Password: </label>
    <input id="password" type="password"/> <br/>
    <button id="submit">
      Submit
    </button>

  </body>
  <script>
  
  const occupySchedule = function() {
    fetch( '/info' )
      .then( function( response ) {
        return response.json()
    }).then( function( myJSON ) {
        var info = myJSON.data
        var i;
        for(i = 0; i < info.length; i++){
          if(document.querySelector(".boardsection[data-board]:first-child .tasklist [id='"+info[i].day + info[i].task + info[i].time+"']") === null){ 
            console.log(info)
            createEvent(info[i].index, info[i].day, info[i].task, info[i].time);
          }
        }
        console.log( JSON.stringify( myJSON ) )
    })
  }
  
  const addEvent = function(e) {
    e.preventDefault();
    var day = document.querySelector("#day").value
    var task = document.querySelector("#task").value
    var time = document.querySelector("#time").value
    var index = day.toLowerCase()  + task.toLowerCase()  + time.toLowerCase() 
    var newEvent = {
      index : index,
      day : document.querySelector("#day").value,
      task : document.querySelector("#task").value,
      time : document.querySelector("#time").value,
    };
    var body = JSON.stringify( newEvent );
    fetch('/submit',{
      method: 'POST',
      body
    }).then( function( response ) {
      createEvent(index, day, task, time);

      document.querySelector("#day").value = '';
      document.querySelector("#task").value = '';
      document.querySelector("#time").value = '';
    })
    
    return false
  }
  
  const deleteEvents = function(e) {
    e.preventDefault();
    var pointer = document.querySelector('.boardsection[data-board]:first-child .tasklist')
    var i;
    var indices = [];
    console.log("Child Nodes Length = " + pointer.childNodes.length)
    for(i = 0; i < pointer.childNodes.length; i++){
      var pointerChild = document.querySelector('.boardsection[data-board]:first-child .tasklist :nth-child('+i+')')
      console.log("Child = " + pointerChild)
      if(pointerChild !== null && pointerChild.getAttribute('id') !== null) {
        console.log(pointerChild.getAttribute('id'))
        indices.push(pointerChild.getAttribute('id'))
      }
    }
    console.log(indices)
    if(indices !== []) {
        delEvent(indices)
    }
  }
  
  
  const delEvent = function(indices) {
    var body = JSON.stringify( indices )
    fetch('/delete',{
      method: 'POST',
      body
    }).then(function(response) {
      console.log(response)
      updateSchedule()
    })
  }
  
  const createEvent = function(index, day, task, time){
      console.log("createEvent")
      var dayNum = dayFinder(day)
      var dayCol = document.querySelector(".boardsection[data-board='"+ dayNum +"'] .tasklist")
      var timeNode = document.createTextNode(time)
      var textNode = document.createTextNode(task)
      var divNode = document.createElement("div")
      var breakNode = document.createElement("br")
      var breakNode1 = document.createElement("br")
      divNode.setAttribute('id', index)
      divNode.appendChild(timeNode)
      divNode.appendChild(breakNode1)
      divNode.appendChild(textNode)

      dayCol.appendChild(divNode)
      dayCol.appendChild(breakNode)
  }
  
  const updateSchedule = function( ) {
    var int = 0;
    console.log("update")
    var pointer = document.querySelector('.boardsection[data-board]:nth-child('+int+') .tasklist ')
    for(int = 0; int < 8; int++) {   
        var pointer = document.querySelector('.boardsection[data-board]:nth-child('+int+') .tasklist ')
        if(pointer!==null){
          while(pointer.firstChild !== null){
            pointer.removeChild(pointer.firstChild)
          }
        }
    }
    occupySchedule()
  }
  
  const dayFinder = function(str) {
    switch(str.trim().toLowerCase()) {
      case 'sunday':
        return 'day_1'
      case 'monday':
        return 'day_2'
      case 'tuesday':
        return 'day_3'
      case 'wednesday':
        return 'day_4'
      case 'thursday':
        return 'day_5'
      case 'friday':
        return 'day_6'
      case 'saturday':
        return 'day_7'
      default: 
        return 'error'
    }
  }

  
  window.onload = function() {
    occupySchedule();
    
    const addbutton = document.querySelector( '#submit' )
    addbutton.onclick = addEvent
    
    const nextButton = document.querySelector( '#next' )
    nextButton.onclick = deleteEvents
    
  }
    

  </script>
</html>
